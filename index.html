<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Таблица умножения</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style>
      .vertical-center {
        min-height: 100%;  /* Fallback for browsers do NOT support vh unit */
        min-height: 100vh; /* These two lines are counted as one :-)       */

        display: flex;
        align-items: center;
      }
      #result {
        display: block;
        line-height: 50px;
      }
      .alert-area {
        margin-top: 10px;
        width: 250px;
      }
      #answerStat {
        width: 250px; 
        display: block;
      }
      span.right {
        color: green;
      }
      span.wrong {
        color: red;
      }
    </style>
  </head>
  <body>
    <div class="col-md-4 col-md-offset-4 vertical-center">
      <div class="container">
          <h4><span id="answerStat"></span></h4>
          <form class="form-inline" id="inputForm">
            <div class="form-group">
              <div class="input-group">
                <div class="input-group-addon"><span id="task"></span></div>
                <input type="text" class="form-control" id="answer" autocomplete="off" placeholder="Ответ">
              </div>
            </div>
          </form>
          <div class="alert-area"></div>
      </div>
    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
    
    <script>
      var Pyth = function() {
        var form;
        var multiplier1, multiplier2;
        var picker;
        var alertCleanTimer;

        var onFormSubmit = function() {
          checkAnswer();
          return false;
        };
        var nextTask = function() {
          n = picker.nextNumbers();
          giveTask(n[0], n[1]);
        }
        var giveTask = function(m1, m2) {
            $('#task').html(m1+' &times; '+m2+' =');
            multiplier1 = m1;
            multiplier2 = m2; 
            $('#answer').val('').focus();
        };
        var checkAnswer = function() {
          var a = $('#answer').val();
          if (a == '') {
            return;
          }
          a = parseInt(a);
          if (isNaN(a)) {
            return;
          }
          $('#answer').blur();
          $('#answer').val('');
          if (a == multiplier1 * multiplier2) {
            alertRight(multiplier1, multiplier2, a);
            picker.logAnswer(multiplier1, multiplier2, true);
          } else {
            alertWrong(multiplier1, multiplier2, a);
            picker.logAnswer(multiplier1, multiplier2, false);
          }
          nextTask();
        };
        var cleanAlerts = function() {
            $('.alert-area').html('');
            if (alertCleanTimer) {
              clearTimeout(alertCleanTimer);
              alertCleanTimer = null;
            }
        }
        var alertRight = function(m1,m2,a) {
          cleanAlerts();
          $('.alert-area').append('<div class="alert alert-success"><strong>Верно!</strong> '+m1+'&times;'+m2+'='+a+'</div>');
          $('#answerStat').append('<span class="right">&bull;<span>');
          runAlertCleanTimer();
        };
        var alertWrong = function(m1,m2,a) {
          cleanAlerts();
          $('.alert-area').append('<div class="alert alert-danger"><strong>'+a+' это не верно!</strong> '+m1+'&times;'+m2+'='+(m1*m2)+'</div>');
          $('#answerStat').append('<span class="wrong">&bull;<span>');
          runAlertCleanTimer();
        };
        var runAlertCleanTimer = function() {
          alertCleanTimer = setTimeout(cleanAlerts, 5000);
        }

        return {
          'init': function(p) {
            picker = p;
            $('#inputForm').submit(onFormSubmit);
            nextTask();
          }
        };
      };

      var Picker = function() {
        var table = {};
        var i,j;
        var initialCell = {
          rights: 0,
          wrongs: 0,
          rightsInRow: 0,
          wrongsInRow: 0,
          lastAnswerIsRight: null
        };

        for (i=1; i<=10; i++) {
          table[i] = {};
          for (j=1; j<=10; j++) {
            table[i][j] = JSON.parse(JSON.stringify(initialCell));
          }
        }

        var pickRandom = function() {
            var m1 = 2 + Math.floor(Math.random() * 7);
            var m2 = 2 + Math.floor(Math.random() * 7);
            return [m1, m2];
        };

        var pickNumbersByCondition = function(condition) {
            var n=0;
            var row = [];

            for (i=2; i<=9; i++) {
              for (j=2; j<=9; j++) {
                if (condition(table[i][j])) {
                  row[n++] = [i,j];
                }
              }
            }

            if (row.length == 0) {
              return pickRandom();
            }

            return row[Math.floor(Math.random() * n)];
        };

        var cond1 = function(cell) {
          if (cell.rightsInRow >= 2) {
            return false;
          }

          return true;
        };

        return {
          'nextNumbers': function() {
            return pickNumbersByCondition(cond1);
          },
          'logAnswer': function (m1, m2, isRight) {
            if (isRight) {
              table[m1][m2].rights ++;
              if (table[m1][m2].lastAnswerIsRight === true) {
                table[m1][m2].rightsInRow ++;
              } else {
                table[m1][m2].rightsInRow = 1;
              }
              table[m1][m2].wrongsInRow = 0;
              table[m1][m2].lastAnswerIsRight = true;
            } else {
              table[m1][m2].wrongs ++;
              if (table[m1][m2].lastAnswerIsRight === false) {
                table[m1][m2].wrongsInRow ++;
              } else {
                table[m1][m2].wrongsInRow = 1;
              }
              table[m1][m2].rightsInRow = 0;
              table[m1][m2].lastAnswerIsRight = false;
            }
          }
        }
      }

      var pyth = new Pyth();
      pyth.init(new Picker());
    </script
  </body>
</html>
